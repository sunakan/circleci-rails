version: 2.1
setup: true

orbs:
  # continuation
  # https://circleci.com/developer/ja/orbs/orb/circleci/continuation
  continuation: circleci/continuation@1

#
# Dynamic Configurationを利用
#
# continuation/continueはcurlが必要なため、alpineなどのdocker imageだとインストールする必要がある
jobs:
  setup:
    docker:
      - image: circleci/circleci-cli:latest
    environment:
      CIRCLECI_CLI_TELEMETRY_OPTOUT: 'true'
    resource_class: small
    steps:
      - checkout
      - run:
          name: debug
          command: |
            #!/usr/bin/env sh
            set -eu
            echo "pwd=$(pwd)"
            uname -a
            whoami
      - run:
          name: circleci-cliコマンドバージョン確認
          command: |
            #!/usr/bin/env sh
            set -eu
            echo '=========================='
            circleci version
            echo '=========================='
            circleci --help
      - run:
          name: config生成
          command: cd .circleci && bin/generate-config.sh
      - continuation/continue:
          configuration_path: .circleci/generated-config.yml
workflows:
  dynamic-config:
    jobs:
      - setup
