version: 2.1
setup: true

orbs:
  # circleci-cli
  # https://circleci.com/developer/orbs/orb/circleci/circleci-cli
  orb-cli: circleci/circleci-cli@0.1.9
  # continuation
  # https://circleci.com/developer/ja/orbs/orb/circleci/continuation
  orb-continuation: circleci/continuation@1
#
# Dynamic Configurationを利用
#
# continuation/continueはcurlが必要なため、alpineなどのdocker imageだとインストールする必要がある
jobs:
  setup:
    machine:
      image: ubuntu-2404:current
    environment:
      CIRCLECI_CLI_TELEMETRY_OPTOUT: 'true'
    resource_class: arm.medium
    steps:
      - checkout
      - run:
          name: debug
          command: |
            #!/usr/bin/env sh
            set -eu
            echo "pwd=$(pwd)"
            uname -a
            whoami
      - orb-cli/install
      - run:
          name: circleci-cliコマンドバージョン確認
          command: |
            #!/usr/bin/env sh
            set -eu
            echo '=========================='
            circleci version
            echo '=========================='
            circleci --help
      - run:
          name: config生成
          command: cd .circleci && bin/generate-config.sh
      - orb-continuation/continue:
          configuration_path: .circleci/generated-config.yml
workflows:
  dynamic-config:
    jobs:
      - setup
